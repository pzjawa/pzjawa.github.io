---
title: 利用Github Actions实现单仓库自动化部署Hexo到Github Pages
tags:
  - Hexo
categories:
  - 博客
abbrlink: 3b13
date: 2024-08-17 00:00:00
cover: https://image.ifeng.asia:5243/files/2/66c0174dc2b1d.webp
description:
keywords: 'Github Actions,Github Pages,Hexo,blog,Github,Git'
---

## 使用单仓库部署的好处

- 无需另设私人仓库储存源码
- 无需另外生成token

## 新建仓库

新建一个名为`[username].github.io`的公共仓库用于存放博客源码和构建后的页面

![](https://image.ifeng.asia:5243/files/2/66c002c4ab8db.webp)

## 配置Github Actions

来到仓库的`Settings`-`Actions`-`General`-`Workflow permissions`，选择`Read and write permissions`和`Allow GitHub Actions to create and approve pull requests`，以确保**Github Actions**有读写权限

![](https://image.ifeng.asia:5243/files/2/66c00332b5004.webp)

在 `.github` 文件夹下添加 `workflows` 文件夹并新建名为 `autodeploy.yml` 的文件

![](https://image.ifeng.asia:5243/files/2/66c0033279c6b.webp)

复制粘贴以下内容：

```yaml
name: 自动部署
on:
  push:
    branches:
      - code # 存放源代码的分支名
  release:
    types:
      - published

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 检查分支
        uses: actions/checkout@v4
        with:
          ref: code # 存放源代码的分支名
          fetch-depth: 0
      - name: Sync local file timestamps
        run: |
          git ls-files -z | while read -d '' path; do touch -d $(git log -1 --format="@%ct" "$path") "$path"; done

      - name: 安装 Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: 安装 Hexo
        run: |
          export TZ='Asia/Shanghai'
          npm install hexo-cli -g

      - name: 缓存 Hexo
        id: cache-npm
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          path: node_modules
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-

      - name: 安装依赖
        if: ${{ steps.cache-npm.outputs.cache-hit != 'true' }}
        run: |
          npm install --save

      - name: 生成静态文件
        run: |
          hexo clean
          hexo generate

      - name: 部署到Github
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: main # 存放构建后页面的分支名
          folder: public
          commit-message: "${{ github.event.head_commit.message }}"
```



## 本地仓库连接到Github

### 添加屏蔽项

打开`.gitignore`，将主题下的`.git`文件夹加入屏蔽项

```TXT
.DS_Store
Thumbs.db
db.json
*.log
node_modules/
public/
.deploy*/
.deploy_git*/
themes/[theme]/.git # [theme]为你所用的主题名
```

为了保证能顺利推送主题文件夹，建议先将主题下的`.git`文件夹移走

### 连接仓库并推送源码

打开**Git Bash**，依次输入：

```bash
git init
git remote add origin git@github.com:[username]/[username].github.io.git
git checkout -b code # 注意这里为存放源码的分支，需要与`autodeploy.yml`中一致
git add .
git commit -m "blog update"
git push origin code # 推送到存放源码的分支
```

等待**Github Actions**完成后，查看主题文件夹是否成功推送到**Github**的源码分支，成功后即可将`.git`文件夹移回

## Github Pages配置

在仓库的`Settings`-`General`-`Default branch`，更改默认分支为构建后页面的分支

![](https://image.ifeng.asia:5243/files/2/66c00332d2f67.webp)

来到`Settings`-`Pages`-`Build and deployment`-`Branch`，设置为构建后页面的分支

![](https://image.ifeng.asia:5243/files/2/66c00332dff81.webp)

等待部署完成后即可正常访问**Github Page**
